<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Admin – Dashboard</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <header>Admin – Dashboard</header>

    <div class="page">
        <nav>
            <h2>Menu</h2>
            <ul>
                <li><a href="admin.html" class="active">Dashboard</a></li>
                <li><a href="admin_rooms.html">Rooms</a></li>
                <li><a href="admin_maintenance.html">Maintenance</a></li>
                <li><a href="admin_mess.html">Mess</a></li>
                <li><a href="admin_hostel_attendance.html">Hostel Attendance</a></li>
                <li><a href="admin_fees.html">Fees</a></li>
                <li><a href="admin_documents.html">Documents</a></li>
                <li><a href="admin_gatepass.html">Gate Pass</a></li>
            </ul>
            <div style="margin-top:20px;">
                <div id="datetime" style="font-size:14px;color:var(--text-muted);margin-bottom:8px;"></div>
                <p id="info" style="font-size:13px;">Welcome, admin.</p>
                <button onclick="logout()" style="margin-top:8px;">Logout</button>
            </div>
        </nav>

        <main>
            <section class="card">
                <h2>Dashboard Overview</h2>
                <p>Quick stats and latest activities across all hostel operations.</p>

                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin:20px 0;">
                    <div class="info-tile">
                        <div class="label">Total Students</div>
                        <div class="value" id="tile-students">0</div>
                    </div>
                    <div class="info-tile">
                        <div class="label">Open Tickets</div>
                        <div class="value" id="tile-open-tickets">0</div>
                    </div>
                    <div class="info-tile">
                        <div class="label">Pending Gate Passes</div>
                        <div class="value" id="tile-pending-passes">0</div>
                    </div>
                    <div class="info-tile">
                        <div class="label">Total Due</div>
                        <div class="value" id="tile-total-due">₹0</div>
                    </div>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                    <div>
                        <h3>Quick Actions</h3>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-top:12px;">
                            <a href="admin_mess.html" class="btn btn-primary">Set Menu</a>
                            <a href="admin_hostel_attendance.html" class="btn btn-primary">Attendance</a>
                            <a href="admin_fees.html" class="btn btn-primary">Fees</a>
                            <a href="admin_gatepass.html" class="btn btn-primary">Gate Pass</a>
                        </div>
                    </div>

                    <div>
                        <h3>Today's Activity</h3>
                        <div class="info-tile" style="padding:16px;">
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;">
                                <div>
                                    <div style="font-size:12px;color:var(--text-muted);">Present</div>
                                    <div class="value" id="today-present">0</div>
                                </div>
                                <div>
                                    <div style="font-size:12px;color:var(--text-muted);">Menu Set</div>
                                    <div class="value" id="today-menu">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <h3 style="margin-top:24px;">Latest Activities</h3>
                <div id="activity-list" style="font-size:13px;color:var(--text-muted);margin-top:12px;">
                    Loading activities...
                </div>
                <div id="dashboard-msg" class="alert" style="display:none;margin-top:12px;"></div>
            </section>
        </main>
    </div>

    <script>
        const API_BASE = window.location.origin;

        function updateDateTime() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            };
            document.getElementById('datetime').textContent =
                now.toLocaleDateString('en-IN', options);
        }

        async function checkAccess() {
            const token = localStorage.getItem("access_token");
            if (!token) {
                window.location.href = "index.html";
                return;
            }

            try {
                const res = await fetch(API_BASE + "/api/me", {
                    headers: {
                        Authorization: "Bearer " + token
                    },
                });

                if (!res.ok) {
                    window.location.href = "index.html";
                    return;
                }

                const data = await res.json();

                if (data.role !== "admin") {
                    document.getElementById("info").textContent =
                        "You are not admin (role: " + data.role + ")";
                    return;
                }

                document.getElementById("info").textContent =
                    "Welcome, admin " + data.username;

                updateDateTime();
                setInterval(updateDateTime, 60000);

                await loadDashboard();
            } catch (err) {
                window.location.href = "index.html";
            }
        }

        async function loadDashboard() {
            const msg = document.getElementById("dashboard-msg");
            msg.style.display = "none";

            try {
                const token = localStorage.getItem("access_token");

                const [ticketsRes, gatepassRes, feesRes] = await Promise.all([
                    fetch(API_BASE + "/api/maintenance/", {
                        headers: {
                            Authorization: "Bearer " + token
                        }
                    }),
                    fetch(API_BASE + "/api/gatepass/", {
                        headers: {
                            Authorization: "Bearer " + token
                        }
                    }),
                    fetch(API_BASE + "/api/fees/all", {
                        headers: {
                            Authorization: "Bearer " + token
                        }
                    })
                ]);

                const [tickets, gatepasses, fees] = await Promise.all([
                    ticketsRes.json(),
                    gatepassRes.json(),
                    feesRes.json()
                ]);

                document.getElementById("tile-students").textContent = 0;

                document.getElementById("tile-open-tickets").textContent =
                    Array.isArray(tickets) ?
                    tickets.filter(t => t.status === "open").length :
                    0;

                document.getElementById("tile-pending-passes").textContent =
                    Array.isArray(gatepasses) ?
                    gatepasses.filter(g => g.status === "pending").length :
                    0;

                let totalDue = 0;
                if (Array.isArray(fees)) {
                    fees.forEach(f => {
                        totalDue += f.total_due || 0;
                    });
                }
                document.getElementById("tile-total-due").textContent = "₹" + totalDue;

                const activities = [{
                    time: "2 min ago",
                    action: "Menu set for today",
                    type: "mess"
                }, {
                    time: "15 min ago",
                    action: "John marked present",
                    type: "attendance"
                }, {
                    time: "1 hr ago",
                    action: "Gate pass #23 approved",
                    type: "gatepass"
                }, {
                    time: "2 hrs ago",
                    action: "Payment recorded: ₹5000",
                    type: "fees"
                }];

                const listDiv = document.getElementById("activity-list");
                listDiv.innerHTML = activities.map(activity =>
                    `<div style="padding:10px 0;border-bottom:1px solid rgba(55,65,81,0.3);display:flex;justify-content:space-between;align-items:center;">
                        <span>${activity.action}</span>
                        <span style="font-size:11px;color:var(--text-muted);">${activity.time}</span>
                     </div>`
                ).join("");

                msg.textContent = "Dashboard loaded.";
                msg.className = "alert success";
                msg.style.display = "block";

            } catch (err) {
                document.getElementById("activity-list").textContent =
                    "Failed to load dashboard data.";
                msg.textContent = "Some data unavailable.";
                msg.className = "alert warning";
                msg.style.display = "block";
            }
        }

        function logout() {
            localStorage.removeItem("access_token");
            localStorage.removeItem("role");
            window.location.href = "index.html";
        }

        checkAccess();
    </script>
</body>

</html>