<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Admin – Mess</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <header>Admin – Mess</header>

    <div class="page">
        <nav>
            <h2>Menu</h2>
            <ul>
                <li><a href="admin.html">Dashboard</a></li>
                <li><a href="admin_rooms.html">Rooms</a></li>
                <li><a href="admin_maintenance.html">Maintenance</a></li>
                <li><a href="admin_mess.html" class="active">Mess</a></li>
                <li><a href="admin_hostel_attendance.html">Hostel Attendance</a></li>
                <li><a href="admin_fees.html">Fees</a></li>
                <li><a href="admin_documents.html">Documents</a></li>
                <li><a href="admin_gatepass.html">Gate Pass</a></li>
            </ul>
            <div style="margin-top:20px;">
                <div id="datetime" style="font-size:14px;color:var(--text-muted);margin-bottom:8px;"></div>
                <p id="info" style="font-size:13px;">Welcome, admin.</p>
                <button onclick="logout()" style="margin-top:8px;">Logout</button>
            </div>
        </nav>

        <main>
            <section class="card" id="mess">
                <h2>Mess – Menu & Stats</h2>
                <p>Configure daily mess menu and track prepared vs served plates.</p>

                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:14px;margin:14px 0;">
                    <div class="info-tile">
                        <div class="label">Today Breakfast</div>
                        <div class="value" id="tile-breakfast">—</div>
                    </div>
                    <div class="info-tile">
                        <div class="label">Today Lunch</div>
                        <div class="value" id="tile-lunch">—</div>
                    </div>
                    <div class="info-tile">
                        <div class="label">Today Dinner</div>
                        <div class="value" id="tile-dinner">—</div>
                    </div>
                </div>

                <h3>Set menu</h3>
                <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
                    <input id="menu-day" type="date" />
                    <select id="menu-meal">
                        <option value="breakfast">Breakfast</option>
                        <option value="lunch">Lunch</option>
                        <option value="dinner">Dinner</option>
                    </select>
                    <input id="menu-items" placeholder="Items comma separated" style="flex:1;min-width:200px;" />
                    <button onclick="setMenu()">Save Menu</button>
                </div>
                <div id="menu-msg" class="alert" style="display:none;margin-top:6px;"></div>

                <h3 style="margin-top:12px;">Today's menu (detail)</h3>
                <button onclick="loadTodayMenu()">Refresh Today Menu</button>
                <div id="today-msg" class="alert" style="display:none;margin-top:6px;"></div>

                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:10px;">
                    <div class="info-tile">
                        <div class="label">Breakfast items</div>
                        <ul id="list-breakfast" style="margin-top:6px;font-size:13px;color:var(--text-muted);padding-left:16px;"></ul>
                    </div>
                    <div class="info-tile">
                        <div class="label">Lunch items</div>
                        <ul id="list-lunch" style="margin-top:6px;font-size:13px;color:var(--text-muted);padding-left:16px;"></ul>
                    </div>
                    <div class="info-tile">
                        <div class="label">Dinner items</div>
                        <ul id="list-dinner" style="margin-top:6px;font-size:13px;color:var(--text-muted);padding-left:16px;"></ul>
                    </div>
                </div>

                <details style="margin-top:10px;font-size:12px;color:var(--text-muted);">
                    <summary>Technical menu JSON</summary>
                    <pre id="today-menu" style="margin-top:6px;">[]</pre>
                </details>

                <h3 style="margin-top:18px;">Mess stats</h3>
                <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:6px;">
                    <input id="stat-day" type="date" />
                    <select id="stat-meal">
                        <option value="breakfast">Breakfast</option>
                        <option value="lunch">Lunch</option>
                        <option value="dinner">Dinner</option>
                    </select>
                    <input id="plates-prepared" type="number" placeholder="Prepared" />
                    <input id="plates-served" type="number" placeholder="Served" />
                    <button onclick="setStats()">Save Stats</button>
                    <button onclick="loadStats()">Refresh Stats</button>
                </div>
                <div id="stats-msg" class="alert" style="display:none;margin-top:6px;"></div>

                <div id="stats-list-pretty" style="font-size:13px;color:var(--text-muted);margin-top:4px;">
                    No stats loaded yet.
                </div>

                <details style="margin-top:10px;font-size:12px;color:var(--text-muted);">
                    <summary>Technical stats JSON</summary>
                    <pre id="stats-list" style="margin-top:6px;">[]</pre>
                </details>
            </section>
        </main>
    </div>

    <script>
        const API_BASE = window.location.origin;

        function updateDateTime() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            };
            document.getElementById('datetime').textContent =
                now.toLocaleDateString('en-IN', options);
        }

        async function checkAccess() {
            const token = localStorage.getItem("access_token");
            if (!token) {
                window.location.href = "index.html";
                return;
            }

            try {
                const res = await fetch(API_BASE + "/api/me", {
                    headers: {
                        Authorization: "Bearer " + token
                    },
                });

                if (!res.ok) {
                    window.location.href = "index.html";
                    return;
                }

                const data = await res.json();

                if (data.role !== "admin") {
                    document.getElementById("info").textContent =
                        "You are not admin (role: " + data.role + ")";
                } else {
                    document.getElementById("info").textContent =
                        "Welcome, admin " + data.username;
                    updateDateTime();
                    setInterval(updateDateTime, 60000);
                    await loadTodayMenu();
                    await loadStats();
                }
            } catch (err) {
                window.location.href = "index.html";
            }
        }

        async function setMenu() {
            const token = localStorage.getItem("access_token");
            const msg = document.getElementById("menu-msg");
            msg.style.display = "none";

            const body = {
                day: document.getElementById("menu-day").value,
                meal: document.getElementById("menu-meal").value,
                items: document
                    .getElementById("menu-items")
                    .value.split(",")
                    .map((s) => s.trim())
                    .filter((s) => s),
            };

            if (!body.day || !body.items.length) {
                msg.textContent = "Select a day and enter at least one item.";
                msg.className = "alert error";
                msg.style.display = "block";
                return;
            }

            try {
                await fetch(API_BASE + "/api/mess/menu", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + token,
                    },
                    body: JSON.stringify(body),
                });
                msg.textContent = "Menu saved.";
                msg.className = "alert success";
                msg.style.display = "block";
                await loadTodayMenu();
            } catch (err) {
                msg.textContent = "Failed to save menu.";
                msg.className = "alert error";
                msg.style.display = "block";
            }
        }

        async function loadTodayMenu() {
            const msg = document.getElementById("today-msg");
            msg.style.display = "none";

            try {
                const res = await fetch(API_BASE + "/api/mess/menu/today");
                if (!res.ok) throw new Error("Failed to load today's menu");
                const data = await res.json();

                document.getElementById("today-menu").textContent =
                    JSON.stringify(data, null, 2);

                document.getElementById("tile-breakfast").textContent =
                    (data.breakfast && data.breakfast.join(", ")) || "—";
                document.getElementById("tile-lunch").textContent =
                    (data.lunch && data.lunch.join(", ")) || "—";
                document.getElementById("tile-dinner").textContent =
                    (data.dinner && data.dinner.join(", ")) || "—";

                fillMenuList("list-breakfast", data.breakfast);
                fillMenuList("list-lunch", data.lunch);
                fillMenuList("list-dinner", data.dinner);

                msg.textContent = "Today's menu loaded.";
                msg.className = "alert success";
                msg.style.display = "block";
            } catch (err) {
                msg.textContent = "Failed to load today's menu.";
                msg.className = "alert error";
                msg.style.display = "block";
            }
        }

        function fillMenuList(id, arr) {
            const ul = document.getElementById(id);
            const items = Array.isArray(arr) && arr.length ? arr : ["No items set."];
            ul.innerHTML = items.map((x) => "<li>" + x + "</li>").join("");
        }

        async function setStats() {
            const token = localStorage.getItem("access_token");
            const msg = document.getElementById("stats-msg");
            msg.style.display = "none";

            const body = {
                day: document.getElementById("stat-day").value,
                meal: document.getElementById("stat-meal").value,
                plates_prepared: parseInt(
                    document.getElementById("plates-prepared").value || "0",
                    10
                ),
                plates_served: parseInt(
                    document.getElementById("plates-served").value || "0",
                    10
                ),
            };

            if (!body.day) {
                msg.textContent = "Select a day for stats.";
                msg.className = "alert error";
                msg.style.display = "block";
                return;
            }

            try {
                await fetch(API_BASE + "/api/mess/stats", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + token,
                    },
                    body: JSON.stringify(body),
                });
                msg.textContent = "Stats saved.";
                msg.className = "alert success";
                msg.style.display = "block";
                await loadStats();
            } catch (err) {
                msg.textContent = "Failed to save stats.";
                msg.className = "alert error";
                msg.style.display = "block";
            }
        }

        async function loadStats() {
            const token = localStorage.getItem("access_token");
            const msg = document.getElementById("stats-msg");
            msg.style.display = "none";

            try {
                const res = await fetch(API_BASE + "/api/mess/stats", {
                    headers: {
                        Authorization: "Bearer " + token
                    },
                });
                if (!res.ok) throw new Error("Failed to load stats");
                const data = await res.json();

                document.getElementById("stats-list").textContent =
                    JSON.stringify(data, null, 2);

                const stats = Array.isArray(data) ? data : [];
                const listDiv = document.getElementById("stats-list-pretty");
                if (stats.length === 0) {
                    listDiv.textContent = "No stats recorded yet.";
                } else {
                    listDiv.innerHTML = stats
                        .map((s) => {
                            const day = s.day || s.date || "-";
                            const meal = s.meal || "-";
                            const prepared = s.plates_prepared || 0;
                            const served = s.plates_served || 0;
                            return (
                                '<div style="padding:6px 8px;border-radius:var(--radius-md);border:1px solid rgba(55,65,81,0.7);margin-bottom:4px;">' +
                                '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px;">' +
                                '<span style="font-weight:600;">' +
                                day +
                                " – " +
                                meal +
                                "</span>" +
                                '<span style="font-size:12px;color:var(--text-muted);">' +
                                served +
                                "/" +
                                prepared +
                                " served" +
                                "</span>" +
                                "</div>" +
                                "</div>"
                            );
                        })
                        .join("");
                }

                msg.textContent = "Stats loaded.";
                msg.className = "alert success";
                msg.style.display = "block";
            } catch (err) {
                msg.textContent = "Failed to load stats.";
                msg.className = "alert error";
                msg.style.display = "block";
            }
        }

        function logout() {
            localStorage.removeItem("access_token");
            localStorage.removeItem("role");
            window.location.href = "index.html";
        }

        checkAccess();
    </script>
</body>

</html>