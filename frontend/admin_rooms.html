<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Admin – Rooms</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <header>Admin – Rooms</header>

    <div class="page">
        <nav>
            <h2>Menu</h2>
            <ul>
                <li><a href="admin.html">Dashboard</a></li>
                <li><a href="admin_rooms.html" class="active">Rooms</a></li>
                <li><a href="admin_maintenance.html">Maintenance</a></li>
                <li><a href="admin_mess.html">Mess</a></li>
                <li><a href="admin_hostel_attendance.html">Hostel Attendance</a></li>
                <li><a href="admin_fees.html">Fees</a></li>
                <li><a href="admin_documents.html">Documents</a></li>
                <li><a href="admin_gatepass.html">Gate Pass</a></li>
            </ul>
            <div style="margin-top:20px;">
                <div id="datetime" style="font-size:14px;color:var(--text-muted);margin-bottom:8px;"></div>
                <p id="info" style="font-size:13px;">Welcome, admin.</p>
                <button onclick="logout()" style="margin-top:8px;">Logout</button>
            </div>
        </nav>

        <main>
            <section class="card">
                <h2>Room Management</h2>
                <p>Create rooms, allocate students, and monitor occupancy.</p>

                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:14px;margin:14px 0;">
                    <div class="info-tile">
                        <div class="label">Total Rooms</div>
                        <div class="value" id="tile-total-rooms">0</div>
                    </div>
                    <div class="info-tile">
                        <div class="label">Occupied</div>
                        <div class="value" id="tile-occupied">0</div>
                    </div>
                    <div class="info-tile">
                        <div class="label">Vacant</div>
                        <div class="value" id="tile-vacant">0</div>
                    </div>
                    <div class="info-tile">
                        <div class="label">Capacity</div>
                        <div class="value" id="tile-capacity">0</div>
                    </div>
                </div>

                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:14px;margin:14px 0;">
                    <div>
                        <h3>Create Room</h3>
                        <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
                            <input id="room-number" placeholder="Room number (e.g. 101)" />
                            <input id="room-capacity" type="number" placeholder="Capacity" min="1" max="6" />
                            <button onclick="createRoom()">Create Room</button>
                        </div>
                        <div id="room-create-msg" class="alert" style="display:none;margin-top:6px;"></div>
                    </div>

                    <div>
                        <h3>Allocate Student</h3>
                        <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
                            <input id="alloc-room" placeholder="Room number" />
                            <input id="alloc-student" placeholder="Student username" />
                            <button onclick="allocateStudent()">Allocate</button>
                        </div>
                        <div id="alloc-msg" class="alert" style="display:none;margin-top:6px;"></div>
                    </div>
                </div>

                <h3 style="margin-top:12px;">All Rooms</h3>
                <button onclick="loadRooms()">Refresh Rooms</button>
                <div id="rooms-msg" class="alert" style="display:none;margin-top:6px;"></div>

                <div id="rooms-list-pretty" style="font-size:13px;color:var(--text-muted);margin-top:4px;">
                    No rooms loaded yet.
                </div>

                <details style="margin-top:10px;font-size:12px;color:var(--text-muted);">
                    <summary>Technical details (JSON)</summary>
                    <pre id="rooms-list">[]</pre>
                </details>
            </section>
        </main>
    </div>

    <script>
        const API_BASE = window.location.origin;

        function updateDateTime() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            };
            document.getElementById('datetime').textContent =
                now.toLocaleDateString('en-IN', options);
        }

        async function checkAccess() {
            const token = localStorage.getItem("access_token");
            if (!token) {
                window.location.href = "index.html";
                return;
            }

            try {
                const res = await fetch(API_BASE + "/api/me", {
                    headers: {
                        Authorization: "Bearer " + token
                    },
                });

                if (!res.ok) {
                    window.location.href = "index.html";
                    return;
                }

                const data = await res.json();

                if (data.role !== "admin") {
                    document.getElementById("info").textContent =
                        "You are not admin (role: " + data.role + ")";
                } else {
                    document.getElementById("info").textContent =
                        "Welcome, admin " + data.username;
                    updateDateTime();
                    setInterval(updateDateTime, 60000);
                    await loadRooms();
                }
            } catch (err) {
                window.location.href = "index.html";
            }
        }

        async function createRoom() {
            const token = localStorage.getItem("access_token");
            const msg = document.getElementById("room-create-msg");
            msg.style.display = "none";

            const roomNumber = document.getElementById("room-number").value.trim();
            const capacity = parseInt(document.getElementById("room-capacity").value || "0");

            if (!roomNumber || !capacity || capacity < 1) {
                msg.textContent = "Enter valid room number and capacity (1-6).";
                msg.className = "alert error";
                msg.style.display = "block";
                return;
            }

            try {
                await fetch(API_BASE + "/api/rooms/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + token,
                    },
                    body: JSON.stringify({
                        room_number: roomNumber,
                        capacity
                    }),
                });
                msg.textContent = "Room created successfully.";
                msg.className = "alert success";
                msg.style.display = "block";
                document.getElementById("room-number").value = "";
                document.getElementById("room-capacity").value = "";
                await loadRooms();
            } catch (err) {
                msg.textContent = "Failed to create room.";
                msg.className = "alert error";
                msg.style.display = "block";
            }
        }

        async function allocateStudent() {
            const token = localStorage.getItem("access_token");
            const msg = document.getElementById("alloc-msg");
            msg.style.display = "none";

            const roomNumber = document.getElementById("alloc-room").value.trim();
            const studentUsername = document.getElementById("alloc-student").value.trim();

            if (!roomNumber || !studentUsername) {
                msg.textContent = "Enter room number and student username.";
                msg.className = "alert error";
                msg.style.display = "block";
                return;
            }

            try {
                await fetch(API_BASE + "/api/rooms/allocate", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + token,
                    },
                    body: JSON.stringify({
                        room_number: roomNumber,
                        username: studentUsername
                    }),
                });
                msg.textContent = "Student allocated successfully.";
                msg.className = "alert success";
                msg.style.display = "block";
                document.getElementById("alloc-room").value = "";
                document.getElementById("alloc-student").value = "";
                await loadRooms();
            } catch (err) {
                msg.textContent = "Failed to allocate student.";
                msg.className = "alert error";
                msg.style.display = "block";
            }
        }

        async function loadRooms() {
            const token = localStorage.getItem("access_token");
            const msg = document.getElementById("rooms-msg");
            msg.style.display = "none";

            try {
                const res = await fetch(API_BASE + "/api/rooms/", {
                    headers: {
                        Authorization: "Bearer " + token
                    },
                });
                if (!res.ok) throw new Error("Failed to load rooms");
                const data = await res.json();

                document.getElementById("rooms-list").textContent =
                    JSON.stringify(data, null, 2);

                const rooms = Array.isArray(data) ? data : [];
                const totalRooms = rooms.length;
                let occupied = 0;
                let totalCapacity = 0;

                rooms.forEach(room => {
                    totalCapacity += room.capacity || 0;
                    if (room.occupants && Array.isArray(room.occupants)) {
                        if (room.occupants.length > 0) occupied++;
                    }
                });

                const vacant = totalRooms - occupied;

                document.getElementById("tile-total-rooms").textContent = totalRooms;
                document.getElementById("tile-occupied").textContent = occupied;
                document.getElementById("tile-vacant").textContent = vacant;
                document.getElementById("tile-capacity").textContent = totalCapacity;

                const listDiv = document.getElementById("rooms-list-pretty");
                if (rooms.length === 0) {
                    listDiv.textContent = "No rooms created yet.";
                } else {
                    const sorted = [...rooms].sort((a, b) => {
                        const occA = (a.occupants || []).length;
                        const occB = (b.occupants || []).length;
                        return occB - occA;
                    });

                    listDiv.innerHTML = sorted
                        .map((room) => {
                            const num = room.room_number || room.number || "-";
                            const cap = room.capacity || 0;
                            const occ = (room.occupants || []).length;
                            const students = room.occupants ?
                                room.occupants.slice(0, 3).map(s => s.username || s).join(", ") :
                                "";
                            const more = occ > 3 ? ` +${occ - 3}` : "";
                            const statusClass =
                                occ === 0 ? "badge-success" :
                                occ < cap ? "badge-warning" : "badge-error";
                            const statusText =
                                occ === 0 ? "Vacant" :
                                occ < cap ? "Partial" : "Full";

                            return (
                                '<div style="padding:8px 10px;border-radius:var(--radius-md);border:1px solid rgba(55,65,81,0.7);margin-bottom:6px;">' +
                                '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px;">' +
                                '<span style="font-weight:600;">Room ' + num + '</span>' +
                                '<span class="' + statusClass + '" style="font-size:11px;text-transform:uppercase;letter-spacing:0.06em;">' +
                                statusText + '</span>' +
                                "</div>" +
                                '<div style="font-size:12px;color:var(--text-muted);">' +
                                occ + '/' + cap + ' occupied • ' +
                                (students ? students + more : "No students") +
                                "</div>" +
                                "</div>"
                            );
                        })
                        .join("");
                }

                msg.textContent = "Rooms loaded.";
                msg.className = "alert success";
                msg.style.display = "block";
            } catch (err) {
                msg.textContent = "Failed to load rooms.";
                msg.className = "alert error";
                msg.style.display = "block";
            }
        }

        function logout() {
            localStorage.removeItem("access_token");
            localStorage.removeItem("role");
            window.location.href = "index.html";
        }

        checkAccess();
    </script>
</body>

</html>